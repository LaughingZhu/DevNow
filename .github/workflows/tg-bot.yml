name: Deploy Tg Notification
on:
  deployment_status

jobs:
  notify:
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success'
    steps:
      - name: Send Telegram Notification
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # 获取最近修改的文件
          FILES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}" \
            | jq -r '.files[].filename')
          
          # 遍历文件并发送通知
          echo "$FILES" | while read -r file; do
            if [[ $file == src/content/* ]] && [[ $file == *.md* ]]; then
              filename=$(basename "$file")
              name="${filename%.*}"
              URL="https://www.laughingzhu.cn/posts/${name}"
              MESSAGE="🔔 新文章已发布: ${URL}"
              
              curl -s -X POST \
                "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
                -d "chat_id=${CHAT_ID}" \
                -d "text=${MESSAGE}" \
                -d "parse_mode=HTML" \
                -d "disable_web_page_preview=false"
            fi
          done
